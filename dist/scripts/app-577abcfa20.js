!function(){"use strict";angular.module("formioServiceTrackerApp",["formio","ngFormioHelper","ui.router","ngMap","bgf.paginateAnything","angularMoment"]).config(["FormioProvider","FormioAuthProvider","FormioResourceProvider","$stateProvider","$urlRouterProvider","AppConfig",function(e,t,o,a,r,i){e.setBaseUrl(i.apiUrl),t.setStates("auth.contractorLogin","home"),t.setForceAuth(!0),t.register("dealerLogin","dealer","dealer"),t.register("adminLogin","admin","admin"),t.register("contractorLogin","contractor","contractor"),a.state("home",{url:"",templateUrl:"views/main.html"}).state("appointments",{url:"/appointments",parent:"home",templateUrl:"views/appointments.html",params:{filter:{},startDate:moment().startOf("day").toDate(),endDate:moment().endOf("day").add(7,"days").toDate(),time_filter:{},time_startDate:moment().startOf("day").toDate(),time_endDate:moment().endOf("day").add(7,"days").toDate()},controller:["$scope","$rootScope","$stateParams","Formio",function(e,t,o,a){e.appointments=[],e.appointmentsUrl=i.appointmentForm+"/submission",e.filter=o.filter,e.minDate=moment().startOf("day").toDate(),e.startDate=o.startDate,e.endDate=o.endDate,t.isRole("admin")||(e.filter["customer.data.dealer._id"]=t.getDealer()._id),t.isRole("contractor")&&!e.filter["assignedContractor._id"]&&(e.filter["assignedContractor._id"]=t.user._id),e.urlParams=t.getUrlParams(e.filter),e.urlParams.sort="data.appointmentTime",e.urlParams["data.appointmentTime__gte"]=e.startDate.toISOString(),e.urlParams["data.appointmentTime__lte"]=e.endDate.toISOString(),e.timeclocks=[],e.timeclocksUrl=i.timeclockForm+"/submission",e.time_filter=o.time_filter,e.time_startDate=o.time_startDate,e.time_endDate=o.time_endDate,t.isRole("contractor")&&(e.time_filter["appointment.data.assignedContractor._id"]=t.user._id),t.isRole("dealer")&&(e.time_filter["appointment.data.assignedContractor.data.dealer._id"]=t.getDealer()._id),e.time_urlParams=t.getUrlParams(e.time_filter),e.time_urlParams.sort="data.time",e.time_urlParams["data.time__gte"]=e.time_startDate.toISOString(),e.time_urlParams["data.time__lte"]=e.time_endDate.toISOString(),e.refreshContractors=function(o){var r={};t.isRole("admin")||(r={"data.dealer._id":t.getDealer()._id}),o&&(r["data.name__regex"]="/"+_.escapeRegExp(o)+"/i"),new a(i.contractorForm).loadSubmissions({params:r}).then(function(t){e.contractors=t})}}]}).state("myforms",{url:"/forms",parent:"home",templateUrl:"views/myforms.html"});var n=function(e,t,o){var a=[],r=e.$on("formLoad",function(e,r){t.eachComponent(r.components,function(e){for(var t in o){var r=o[t];e.key===r&&(a.push({component:e,originalType:e.type}),e.type="hidden")}})});e.$on("$destroy",function(){r(),angular.forEach(a,function(e){e.component.type=e.originalType})})};o.register("contractor",i.contractorForm,{parent:"home",templates:{index:"views/contractor/index.html"},params:{index:{filter:{}}},index:["$scope","$rootScope","$stateParams",function(e,t,o){if(e.contractors=[],e.contractorsUrl=i.contractorForm+"/submission",e.filter=o.filter,!t.isRole("admin")){var a=t.getDealer();a&&(e.filter["dealer._id"]=a._id)}e.urlParams=t.getUrlParams(e.filter)}],create:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||(e.submission.data={dealer:t.getDealer()},n(e,o,["dealer"]))}],view:["$scope","$rootScope","FormioUtils",function(e,t,o){var a=["password","submit"];t.isRole("admin")||a.push("dealer"),n(e,o,a)}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||n(e,o,["dealer"])}]}),o.register("customer",i.customerForm,{parent:"home",templates:{view:"views/customer/view.html",index:"views/customer/index.html"},params:{index:{filter:{},showInactive:!1}},"abstract":["$scope","$rootScope",function(e,t){t.isRole("admin")||(e.hideDelete=!0)}],index:["$scope","$rootScope","$stateParams",function(e,t,o){e.customers=[],e.customersUrl=i.customerForm+"/submission",e.filter=o.filter,e.showInactive=o.showInactive,t.isRole("admin")||(e.filter["dealer._id"]=t.getDealer()._id),e.urlParams=t.getUrlParams(e.filter),e.showInactive||(e.urlParams["data.inactive"]=!1)}],create:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||(e.submission.data={dealer:t.getDealer()},n(e,o,["dealer"]))}],view:["$scope","$rootScope","$state","$stateParams","Formio",function(e,t,o,a,r){e.position={lat:"40.74",lng:"-74.18"},e.urlParams={"data.customer._id":a.customerId},e.$watch("currentResource.resource.data.address.geometry.location",function(t){t&&(e.position.lat=t.lat,e.position.lng=t.lng)}),e.equipment=[],e.equipmentUrl=i.equipmentForm+"/submission",e.appointments=[],e.appointmentsUrl=i.appointmentForm+"/submission",e.forms=i.forms,e.formSubmissions={},e.gotoSubmission=function(e,t){var a={};a[e.name+"Id"]=t._id,a.customerId=t.data.customer._id,o.go(e.name+".view",a)},angular.forEach(e.forms,function(t){e.formSubmissions[t.name]=[],new r(t.form).loadSubmissions({params:{"data.customer._id":a.customerId}}).then(function(o){e.formSubmissions[t.name]=o})})}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||n(e,o,["dealer"])}]}),o.register("dealer",i.dealerForm,{parent:"home",templates:{index:"views/dealer/index.html"},params:{index:{filter:{}}},index:["$scope","$rootScope","$stateParams","FormioUtils",function(e,t,o,a){if(t.isRole("admin"))e.dealers=[],e.dealersUrl=i.dealerForm+"/submission",e.filter=o.filter,e.urlParams=t.getUrlParams(e.filter);else{var r=t.getDealer();r&&(e.dealerUrl=i.dealerForm+"/submission/"+r._id,t.isRole("dealer")||n(e,a,["password"]))}}],create:["$scope","$rootScope","$state",function(e,t,o){t.isRole("admin")||o.go("home")}],view:["$scope","$rootScope","FormioUtils",function(e,t,o){n(e,o,["password","submit"])}],edit:["$scope","$rootScope","$state",function(e,t,o){t.isRole("admin")||o.go("home")}],"delete":["$scope","$rootScope","$state",function(e,t,o){t.isRole("admin")||o.go("home")}]}),o.register("appointment",i.appointmentForm,{parent:"customer",templates:{view:"views/appointment/view.html"},params:{create:{customer:null}},create:["$scope","$rootScope","$stateParams","FormioUtils",function(e,t,o,a){e.submission={data:{}},e.$watch("customer.resource",function(t){t&&t.data&&(e.submission.data.customer=t,n(e,a,["customer"]))}),t.isRole("admin")||e.$on("formLoad",function(e,o){var r=a.getComponent(o.components,"customer"),i=a.getComponent(o.components,"assignedContractor"),n={"data.dealer._id":t.getDealer()._id};r.params=n,i.params=n}),t.isRole("contractor")&&(e.submission.data.assignedContractor=t.user)}],view:["$scope","$rootScope","$stateParams",function(e,t,o){e.timeclocks=[],e.timeclocksUrl=i.timeclockForm+"/submission",e.urlParams={sort:"data.time"},e.services=[],e.servicesUrl=i.serviceForm+"/submission",e.serviceUrlParams={"data.appointment._id":o.appointmentId,sort:"created"}}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||e.$on("formLoad",function(e,a){var r=o.getComponent(a.components,"customer"),i=o.getComponent(a.components,"assignedContractor"),n={"data.dealer._id":t.getDealer()._id};r.params=n,i.params=n})}]}),o.register("timeclock",i.timeclockForm,{parent:"appointment",params:{create:{appointmentId:null}},templates:{view:"views/timeclock/view.html"},create:["$scope","$rootScope","$stateParams","Formio","FormioUtils",function(e,t,o,a,r){e.submission={data:{}},e.$watch("appointment.resource",function(t){t&&t.data&&(e.submission.data.appointment=t,n(e,r,["appointment"]))}),t.isRole("admin")||e.$on("formLoad",function(e,o){var a,i=r.getComponent(o.components,"appointment");t.isRole("dealer")&&(a={"data.customer.data.dealer._id":t.getDealer()._id}),t.isRole("contractor")&&(a={"data.assignedContractor._id":t.user._id}),i.params=a}),e.$on("formSubmit",function(e,t){t.owner=t.data.appointment.data.assignedContractor._id}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e.submission.data.gpsLatitude=t.coords.latitude,e.submission.data.gpsLongitude=t.coords.longitude},function(){console.warn("Unable to retrieve location")}):console.warn("Geolocation is not supported. Cannot add GPS data to this time entry.")}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){t.isRole("admin")||e.$on("formLoad",function(e,a){var r,i=o.getComponent(a.components,"appointment");t.isRole("dealer")&&(r={"data.customer.data.dealer._id":t.getDealer()._id}),t.isRole("contractor")&&(r={"data.assignedContractor._id":t.user._id}),i.params=r}),e.$on("formSubmit",function(e,t){t.owner=t.data.appointment.data.assignedContractor._id})}],"delete":["$scope","$rootScope","$state",function(e,t,o){return e.$on("delete",function(){o.go("appointment.view",{appointmentId:e.currentResource.resource.data.appointment._id})}),!0}]}),o.register("equipment",i.equipmentForm,{parent:"customer",params:{create:{customerId:null}},templates:{view:"views/equipment/view.html"},create:["$scope","$rootScope","$stateParams","Formio","FormioUtils",function(e,t,o,a,r){e.submission={data:{}},e.$watch("customer",function(t){t.resource&&t.resource.data&&(e.submission.data.customer=t.resource)},!0),n(e,r,["customer"]),t.isRole("admin")||e.$on("formLoad",function(e,o){var a=r.getComponent(o.components,"customer"),i={"data.dealer._id":t.getDealer()._id};a.params=i})}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){n(e,o,["customer"]),t.isRole("admin")||e.$on("formLoad",function(e,a){var r=o.getComponent(a.components,"customer"),i={"data.dealer._id":t.getDealer()._id};r.params=i})}]}),o.register("service",i.serviceForm,{parent:"appointment",templates:{view:"views/service/view.html"},create:["$scope","$rootScope","$stateParams","Formio","FormioUtils",function(e,t,o,a,r){e.submission={data:{}},e.$watch("appointment",function(t){t&&t.resource&&(e.submission.data.appointment=t.resource)},!0),n(e,r,["appointment"]),t.isRole("admin")||e.$on("formLoad",function(e,o){var a,i=r.getComponent(o.components,"appointment");t.isRole("dealer")&&(a={"data.customer.data.dealer._id":t.getDealer()._id}),t.isRole("contractor")&&(a={"data.assignedContractor._id":t.user._id}),i.params=a})}],edit:["$scope","$rootScope","FormioUtils",function(e,t,o){n(e,o,["appointment"]),t.isRole("admin")||e.$on("formLoad",function(e,a){var r,i=o.getComponent(a.components,"appointment");t.isRole("dealer")&&(r={"data.customer.data.dealer._id":t.getDealer()._id}),t.isRole("contractor")&&(r={"data.assignedContractor._id":t.user._id}),i.params=r})}]}),angular.forEach(i.forms,function(e){o.register(e.name,e.form,{parent:"customer",params:{create:{customerId:null}},create:["$scope","$rootScope","$state","$stateParams","Formio","FormioUtils",function(e,t,o,a,r,i){return e.submission={data:{}},e.$watch("customer",function(t){t.resource&&t.resource.data&&(e.submission.data.customer=t.resource)},!0),n(e,i,["customer"]),e.$on("formSubmission",function(){o.go("customer.view")}),{handle:!0}}]})}),r.otherwise("/appointment")}]).directive("resourcePanel",function(){return{restrict:"E",replace:!0,scope:{index:"&",title:"=",queryId:"="},templateUrl:"views/resource/panel.html"}}).factory("GoogleAnalytics",["$window","$state",function(e,t){var o=function(e){return e.parent?o(t.get(e.parent))+e.url:e.url};return{sendPageView:function(){e.ga("set","page",o(t.current)),e.ga("send","pageview")},sendEvent:function(t,o,a,r){e.ga("send","event",t,o,a,r)}}}]).run(["$rootScope","$state","$stateParams","Formio","FormioAlerts","FormioAuth","AppConfig","GoogleAnalytics",function(e,t,o,a,r,i,n,s){e.company=n.company,e.baseUrl=n.apiUrl,e.dealerLoginForm=n.dealerLoginForm,e.adminLoginForm=n.adminLoginForm,e.contractorLoginForm=n.contractorLoginForm,i.init(),e.getUrlParams=function(e){return _(e||{}).mapValues(function(e){return"/"+_.escapeRegExp(e)+"/i"}).mapKeys(function(e,t){return"data."+t+"__regex"}).value()},e.getDealer=function(){return e.isRole("dealer")?e.user:e.isRole("contractor")?e.user.data.dealer:{_id:""}},e.getUserName=function(){return e.user&&e.user.data?e.user.data.name||e.user.data.firstName+" "+e.user.data.lastName:""},e.isActive=function(e){return-1!==t.current.name.indexOf(e)},e.$on("$stateChangeStart",function(o,a){(_.startsWith(a.name,"contractor")||_.startsWith(a.name,"dealer"))&&e.isRole("contractor")&&(o.preventDefault(),t.go("home",null,{reload:!0})),"home"===a.name&&(o.preventDefault(),t.go("appointments",null,{reload:!0}))}),e.$on("$stateChangeSuccess",function(){s.sendPageView()}),e.$state=t}])}();